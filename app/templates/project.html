{% extends "base.html" %}

{% block title %}Project - HeinerCast{% endblock %}

{% block content %}
<div class="project-page">
<style>
.project-stats {
    display: flex;
    gap: 2rem;
    margin-top: 1.5rem;
    padding: 1rem;
    background: var(--bg-secondary, #f5f5f5);
    border-radius: 8px;
}
.stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
}
.stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--primary, #007bff);
}
.stat-label {
    font-size: 0.85rem;
    color: var(--text-secondary, #666);
}
</style>

    <div class="page-header">
        <a href="/dashboard" class="back-link">‚Üê Back to Projects</a>
        <div class="page-actions">
            <button class="btn btn-outline" onclick="exportProject()">üì¶ Export</button>
            <button class="btn btn-outline" onclick="showEditProjectModal()">Edit</button>
            <button class="btn btn-danger-outline" onclick="confirmDeleteProject()">Delete</button>
        </div>
    </div>
    
    <div class="project-info" id="project-info">
        <div class="loading-spinner">Loading project...</div>
    </div>
    
    <div class="project-sections">
        <!-- Characters Section -->
        <section class="section">
            <div class="section-header">
                <h2>Characters</h2>
                <button class="btn btn-outline btn-sm" onclick="showAddCharacterModal()">
                    + Add Character
                </button>
            </div>
            <div class="characters-list" id="characters-list">
                <!-- Characters will be loaded here -->
            </div>
        </section>
        
        <!-- Episodes Section -->
        <section class="section">
            <div class="section-header">
                <h2>Episodes</h2>
                <button class="btn btn-primary" onclick="showCreateEpisodeModal()">
                    + New Episode
                </button>
            </div>
            <div class="episodes-list" id="episodes-list">
                <!-- Episodes will be loaded here -->
            </div>
        </section>
    </div>
</div>

<!-- Add Character Modal -->
<div class="modal" id="add-character-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add Character</h2>
            <button class="modal-close" onclick="closeModal('add-character-modal')">&times;</button>
        </div>
        <form id="add-character-form" onsubmit="addCharacter(event)">
            <div class="form-group">
                <label for="char-name">Character Name *</label>
                <input type="text" id="char-name" required maxlength="100"
                       placeholder="e.g., Andr√© Heiner">
            </div>
            <div class="form-group">
                <label for="char-role">Role *</label>
                <input type="text" id="char-role" required maxlength="100"
                       placeholder="e.g., Main Character">
            </div>
            <div class="form-group">
                <label for="char-voice">Voice *</label>
                <select id="char-voice" required>
                    <option value="">Select a voice...</option>
                </select>
                <a href="/voices" class="form-hint-link">Manage voice library ‚Üí</a>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('add-character-modal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Character</button>
            </div>
        </form>
    </div>
</div>


<!-- Edit Character Modal -->
<div class="modal" id="edit-character-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Edit Character</h2>
            <button class="modal-close" onclick="closeModal('edit-character-modal')">&times;</button>
        </div>
        <form id="edit-character-form" onsubmit="updateCharacter(event)">
            <input type="hidden" id="edit-char-id">
            <div class="form-group">
                <label for="edit-char-name">Character Name *</label>
                <input type="text" id="edit-char-name" required maxlength="100">
            </div>
            <div class="form-group">
                <label for="edit-char-role">Role *</label>
                <input type="text" id="edit-char-role" required maxlength="100">
            </div>
            <div class="form-group">
                <label for="edit-char-voice">Voice *</label>
                <select id="edit-char-voice" required>
                    <option value="">Select a voice...</option>
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('edit-character-modal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
</div>
<!-- Create Episode Modal -->
<div class="modal" id="create-episode-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>New Episode</h2>
            <button class="modal-close" onclick="closeModal('create-episode-modal')">&times;</button>
        </div>
        <form id="create-episode-form" onsubmit="createEpisode(event)">
            <div class="form-group">
                <label for="ep-title">Title (optional)</label>
                <input type="text" id="ep-title" maxlength="200"
                       placeholder="Leave empty to auto-generate">
                <label class="checkbox-label">
                    <input type="checkbox" id="ep-auto-title" checked>
                    <span>Auto-generate title from script</span>
                </label>
            </div>
            <div class="form-group">
                <label for="ep-description">Description *</label>
                <textarea id="ep-description" required maxlength="5000" rows="4"
                          placeholder="What happens in this episode..."></textarea>
            </div>
            <div class="form-group">
                <label for="ep-duration">Target Duration (minutes) *</label>
                <input type="number" id="ep-duration" required min="1" max="60" value="10">
            </div>
            <div class="form-row">
                <label class="checkbox-label">
                    <input type="checkbox" id="ep-sounds">
                    <span>Include sound effects</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="ep-music">
                    <span>Include background music</span>
                </label>
            </div>
            <label class="checkbox-label">
                <input type="checkbox" id="ep-show-number" checked>
                <span>Show episode number in title</span>
            </label>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('create-episode-modal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Episode</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const projectId = '{{ project_id }}';
let project = null;
let voices = [];

async function loadProject() {
    try {
        const result = await api.get(`/api/projects/${projectId}`);
        if (result.ok && result.data) {
            project = result.data;
            renderProject();
            loadVoices();
            loadStats();
        }
    } catch (error) {
        showError(error, 'Load project');
    }
}

async function loadVoices() {
    try {
        const result = await api.get('/api/voices');
        if (result.ok && result.data) {
            voices = Array.isArray(result.data) ? result.data : (result.data.items || []);
            updateVoiceSelect();
        }
    } catch (error) {
        console.error('Failed to load voices', error);
    }

}
async function loadStats() {
    try {
        const result = await api.get(`/api/projects/${projectId}/stats`);
        if (result.ok && result.data) {
            renderStats(result.data);
        }
    } catch (error) {
        console.error("Failed to load stats", error);
    }
}

function renderStats(stats) {
    const statsHtml = `
        <div class="project-stats">
            <div class="stat-item">
                <span class="stat-value">${stats.episodes_count}</span>
                <span class="stat-label">Episodes</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">${stats.total_duration_formatted}</span>
                <span class="stat-label">Total Duration</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">${stats.voices.length}</span>
                <span class="stat-label">Voices</span>
            </div>
        </div>
    `;
    const infoDiv = document.getElementById("project-info");
    infoDiv.insertAdjacentHTML("beforeend", statsHtml);
}


function updateVoiceSelect() {
    const select = document.getElementById('char-voice');
    select.innerHTML = '<option value="">Select a voice...</option>' +
        voices.map(v => `<option value="${v.id}">${escapeHtml(v.name)} (${escapeHtml(v.elevenlabs_name)})</option>`).join('');
}

function renderProject() {
    const infoDiv = document.getElementById('project-info');
    infoDiv.innerHTML = `
        <h1 class="project-page-title">${escapeHtml(project.title)}</h1>
        <p class="project-page-description">${escapeHtml(project.description)}</p>
        <div class="project-meta">
            <span class="meta-item"><strong>Genre:</strong> ${escapeHtml(project.genre_tone)}</span>
            ${project.musical_atmosphere ? `<span class="meta-item"><strong>Atmosphere:</strong> ${escapeHtml(project.musical_atmosphere)}</span>` : ''}
        </div>
        <div class="project-options">
            ${project.include_sound_effects ? '<span class="tag">üîä Sound Effects</span>' : ''}
            ${project.include_background_music ? '<span class="tag">üéµ Background Music</span>' : ''}
        </div>
    `;
    
    // Render characters
    const charList = document.getElementById('characters-list');
    if (project.characters && project.characters.length > 0) {
        charList.innerHTML = project.characters.map(char => `
            <div class="character-card">
                <div class="character-info">
                    <span class="character-icon">üë§</span>
                    <div>
                        <div class="character-name">${escapeHtml(char.character_name)}</div>
                        <div class="character-role">${escapeHtml(char.role)}</div>
                    </div>
                </div>
                <div class="character-voice">
                    ‚Üí ${escapeHtml(char.elevenlabs_name || 'No voice')}
                </div>
                <button class="btn-icon" onclick="showEditCharacterModal('${char.id}')" title="Edit">‚úèÔ∏è</button>
                <button class="btn-icon" onclick="deleteCharacter('${char.id}')" title="Remove">üóëÔ∏è</button>
            </div>
        `).join('');
    } else {
        charList.innerHTML = '<p class="empty-text">No characters yet. Add characters to assign voices for your episodes.</p>';
    }
    
    // Load episodes
    loadEpisodes();
}

async function loadEpisodes() {
    try {
        const result = await api.get(`/api/projects/${projectId}/episodes`);
        
        if (!result.ok || !result.data) return;
        
        const data = result.data;
        const epList = document.getElementById('episodes-list');
        const items = data.items || [];
        
        if (items.length > 0) {
            epList.innerHTML = items.map(ep => `
                <a href="/episodes/${ep.id}" class="episode-card">
                    <div class="episode-header">
                        <span class="episode-number">#${ep.episode_number}</span>
                        <span class="episode-status status-${ep.status}">${formatStatus(ep.status)}</span>
                    </div>
                    <h3 class="episode-title">${escapeHtml(ep.title)}</h3>
                    <div class="episode-meta">
                        ${ep.final_audio_duration_seconds ? `<span>${formatDuration(ep.final_audio_duration_seconds)}</span>` : ''}
                        ${ep.include_sound_effects ? '<span>üîä</span>' : ''}
                        ${ep.include_background_music ? '<span>üéµ</span>' : ''}
                    </div>
                    ${ep.status === 'done' ? `
                        <div class="episode-actions">
                            <button class="btn btn-sm btn-outline" onclick="event.preventDefault(); playAudio('${ep.id}')">‚ñ∂Ô∏è Play</button>
                            <button class="btn btn-sm btn-outline" onclick="event.preventDefault(); downloadAudio('${ep.id}')">üì•</button>
                        </div>
                    ` : ''}
                </a>
            `).join('');
        } else {
            epList.innerHTML = '<p class="empty-text">No episodes yet. Create your first episode to start generating content.</p>';
        }
    } catch (error) {
        showError(error, 'Load episodes');
    }
}

function showAddCharacterModal() {
    if (project.characters && project.characters.length >= 5) {
        showToast('Maximum 5 characters per project', 'warning');
        return;
    }
    document.getElementById('add-character-modal').classList.add('active');
}

async function addCharacter(event) {
    event.preventDefault();
    
    const data = {
        character_name: document.getElementById('char-name').value,
        role: document.getElementById('char-role').value,
        voice_id: document.getElementById('char-voice').value,
        sort_order: (project.characters?.length || 0)
    };
    
    try {
        const result = await api.post(`/api/projects/${projectId}/characters`, data);
        if (result.ok) {
            showToast('Character added!', 'success');
            closeModal('add-character-modal');
            loadProject();
        }
        // Error already shown by handleResponse
    } catch (error) {
        showError(error, 'Add character');
    }
}

async function deleteCharacter(charId) {
    if (!confirm('Remove this character?')) return;
    
    try {
        const result = await api.delete(`/api/projects/${projectId}/characters/${charId}`);
        if (result.ok) {
            showToast('Character removed', 'success');
            loadProject();
        }
    } catch (error) {
        showError(error, 'Remove character');
    }
}

async function showEditCharacterModal(charId) {
    const char = project.characters.find(c => c.id === charId);
    if (!char) return;
    
    document.getElementById('edit-char-id').value = charId;
    document.getElementById('edit-char-name').value = char.character_name;
    document.getElementById('edit-char-role').value = char.role;
    
    // Load voices into select
    const select = document.getElementById('edit-char-voice');
    select.innerHTML = '<option value="">Select a voice...</option>';
    try {
        const result = await api.get('/api/voices');
        if (result.ok) {
            result.data.forEach(voice => {
                const option = document.createElement('option');
                option.value = voice.id;
                option.textContent = voice.name;
                if (voice.id === char.voice_id) option.selected = true;
                select.appendChild(option);
            });
        }
    } catch (e) { console.error(e); }
    
    document.getElementById('edit-character-modal').classList.add('active');
}

async function updateCharacter(event) {
    event.preventDefault();
    
    const charId = document.getElementById('edit-char-id').value;
    const data = {
        character_name: document.getElementById('edit-char-name').value,
        role: document.getElementById('edit-char-role').value,
        voice_id: document.getElementById('edit-char-voice').value
    };
    
    try {
        const result = await api.put(`/api/projects/${projectId}/characters/${charId}`, data);
        if (result.ok) {
            showToast('Character updated!', 'success');
            closeModal('edit-character-modal');
            loadProject();
        }
    } catch (error) {
        showError(error, 'Update character');
    }
}

function showCreateEpisodeModal() {
    // Set default options from project
    document.getElementById('ep-sounds').checked = project.include_sound_effects;
    document.getElementById('ep-music').checked = project.include_background_music;
    document.getElementById('create-episode-modal').classList.add('active');
}

async function createEpisode(event) {
    event.preventDefault();
    
    const data = {
        title: document.getElementById('ep-title').value || null,
        title_auto_generated: document.getElementById('ep-auto-title').checked,
        description: document.getElementById('ep-description').value,
        target_duration_minutes: parseInt(document.getElementById('ep-duration').value),
        include_sound_effects: document.getElementById('ep-sounds').checked,
        include_background_music: document.getElementById('ep-music').checked,
        show_episode_number: document.getElementById('ep-show-number').checked
    };
    
    try {
        const result = await api.post(`/api/projects/${projectId}/episodes`, data);
        if (result.ok && result.data) {
            showToast('Episode created!', 'success');
            closeModal('create-episode-modal');
            window.location.href = `/episodes/${result.data.id}`;
        }
        // Error already shown by handleResponse
    } catch (error) {
        showError(error, 'Create episode');
    }
}


function exportProject() {
    showToast("Preparing ZIP archive...", "info");
    window.location.href = `/api/projects/${projectId}/export`;
}

async function confirmDeleteProject() {
    if (!confirm('Delete this project and all its episodes? This cannot be undone.')) return;
    
    try {
        const result = await api.delete(`/api/projects/${projectId}`);
        if (result.ok) {
            showToast('Project deleted', 'success');
            window.location.href = '/dashboard';
        }
    } catch (error) {
        showError(error, 'Delete project');
    }
}

function formatStatus(status) {
    const statusMap = {
        'draft': 'üìù Draft',
        'script_generating': '‚è≥ Generating script...',
        'script_done': '‚úÖ Script ready',
        'voiceover_generating': 'üéôÔ∏è Generating voice...',
        'voiceover_done': '‚úÖ Voice ready',
        'sounds_generating': 'üîä Generating sounds...',
        'sounds_done': '‚úÖ Sounds ready',
        'music_generating': 'üéµ Generating music...',
        'music_done': '‚úÖ Music ready',
        'merging': 'üîÑ Merging audio...',
        'audio_done': '‚úÖ Audio ready',
        'cover_generating': 'üé® Generating cover...',
        'done': '‚úÖ Done',
        'error': '‚ùå Error'
    };
    return statusMap[status] || status;
}

// Load on page load
document.addEventListener('DOMContentLoaded', loadProject);
</script>
{% endblock %}
