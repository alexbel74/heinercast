{% extends "base.html" %}

{% block title %}Episode - HeinerCast{% endblock %}

{% block content %}
<div class="episode-page">
    <div class="page-header">
        <a href="#" id="back-link" class="back-link">‚Üê Back to Project</a>
        <div class="page-actions" id="page-actions">
            <!-- Actions will be loaded based on status -->
        </div>
    </div>
    
    <div class="episode-header" id="episode-header">
        <div class="loading-spinner">Loading episode...</div>
    </div>
    
    <!-- Tabs -->
    <div class="tabs" id="episode-tabs">
        <button class="tab active" data-tab="script">Script</button>
        <button class="tab" data-tab="audio">Audio</button>
        <button class="tab" data-tab="cover">Cover</button>
        <button class="tab" data-tab="music" id="music-tab" style="display:none;">Music</button>
        <button class="tab" data-tab="sounds" id="sounds-tab" style="display:none;">Sounds</button>
    </div>
    
    <!-- Tab Contents -->
    <div class="tab-content active" id="tab-script">
        <div class="script-container" id="script-container">
            <!-- Script will be loaded here -->
        </div>
    </div>
    
    <div class="tab-content" id="tab-audio">
        <div class="audio-container" id="audio-container">
            <!-- Audio player will be loaded here -->
        </div>
    </div>
    
    <div class="tab-content" id="tab-cover">
        <div class="cover-container" id="cover-container">
            <!-- Cover will be loaded here -->
        </div>
    </div>

    <div class="tab-content" id="tab-music">
        <div class="music-container" id="music-container">
            <!-- Music will be loaded here -->
        </div>
    </div>

    <div class="tab-content" id="tab-sounds">
        <div class="sounds-container" id="sounds-container">
            <!-- Sounds will be loaded here -->
        </div>
    </div>
    <!-- Generation Progress -->
    <div class="generation-progress" id="generation-progress" style="display: none;">
        <h3>Generation Progress</h3>
        <div class="progress-steps" id="progress-steps">
            <!-- Progress steps will be rendered here -->
        </div>

    </div>

    <!-- Cover Generation Modal -->
    <div id="cover-modal" class="modal">
        <div class="modal-backdrop" onclick="closeCoverModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>Generate Cover</h3>
                <button class="modal-close" onclick="closeCoverModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Reference Images (optional, up to 3)</label>
                    <div class="reference-images-container" id="reference-images-container">
                        <div class="reference-slots">
                            <div class="reference-slot" id="ref-slot-0" onclick="triggerRefUpload(0)">
                                <input type="file" id="ref-file-0" accept="image/*" onchange="handleMultiRefUpload(event, 0)" style="display:none;">
                                <div class="ref-preview" style="display:none;"></div>
                                <div class="ref-placeholder">üì∑ +</div>
                            </div>
                            <div class="reference-slot" id="ref-slot-1" onclick="triggerRefUpload(1)">
                                <input type="file" id="ref-file-1" accept="image/*" onchange="handleMultiRefUpload(event, 1)" style="display:none;">
                                <div class="ref-preview" style="display:none;"></div>
                                <div class="ref-placeholder">üì∑ +</div>
                            </div>
                            <div class="reference-slot" id="ref-slot-2" onclick="triggerRefUpload(2)">
                                <input type="file" id="ref-file-2" accept="image/*" onchange="handleMultiRefUpload(event, 2)" style="display:none;">
                                <div class="ref-preview" style="display:none;"></div>
                                <div class="ref-placeholder">üì∑ +</div>
                            </div>
                        </div>
                        <span class="hint">Style reference, character reference, etc.</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>Aspect Ratio</label>
                    <select id="aspect-ratio" class="form-control">
                        <option value="1:1" selected>1:1 ‚Äî Square (Podcasts, Spotify)</option>
                        <option value="16:9">16:9 ‚Äî YouTube Thumbnail</option>
                        <option value="9:16">9:16 ‚Äî Stories (Instagram, TikTok)</option>
                        <option value="4:3">4:3 ‚Äî Classic</option>
                        <option value="3:4">3:4 ‚Äî Portrait/Poster</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Cover Style</label>
                    <select id="cover-style" class="form-control">
                        <option value="auto">üé≤ Loading styles...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Additional Instructions (optional)</label>
                    <textarea id="custom-prompt" class="form-control" rows="3" placeholder="e.g. Use character from image 1, style from image 2, add logo from image 3..."></textarea>
                </div>
                <div class="form-group">
                    <label>Number of variants</label>
                    <select id="variants-count" class="form-control">
                        <option value="1">1 variant</option>
                        <option value="2">2 variants</option>
                        <option value="3">3 variants</option>
                        <option value="4" selected>4 variants</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeCoverModal()">Cancel</button>
                <button class="btn btn-primary" onclick="startCoverGeneration()">Generate Cover</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const episodeId = '{{ episode_id }}';
let episode = null;
let pollInterval = null;

async function loadCoverStyles() {
    try {
        const result = await api.get("/api/cover-styles?active_only=true");
        const styles = result.data || result;
        const select = document.getElementById("cover-style");
        select.innerHTML = styles.map(s => 
            `<option value="${s.key}">${s.emoji} ${s.name}</option>`
        ).join("");
    } catch (e) {
        console.error("Failed to load cover styles:", e);
    }
}

async function loadEpisode() {
    try {
        const result = await api.get(`/api/episodes/${episodeId}`);
        if (result.ok && result.data) {
            episode = result.data;
            renderEpisode();
            
            // Start polling if in progress
            if (isInProgress(episode.status)) {
                startPolling();
            }
        }
        // Error toast is handled by api.handleResponse
    } catch (error) {
        showError(error, t('common.loading'));
    }
}

function isInProgress(status) {
    return ['script_generating', 'voiceover_generating', 'sounds_generating', 
            'music_generating', 'merging', 'cover_generating'].includes(status);
}

function renderEpisode() {
    document.getElementById('back-link').href = `/projects/${episode.project_id}`;
    
    // Header
    const header = document.getElementById('episode-header');
    header.innerHTML = `
        <div class="episode-title-row">
            <h1>#${episode.episode_number}: ${escapeHtml(episode.title)}</h1>
            <span class="status-badge status-${episode.status}">${formatStatus(episode.status)}</span>
        </div>
        <p class="episode-description">${escapeHtml(episode.description)}</p>
        <div class="episode-meta">
            <span>Target: ${episode.target_duration_minutes} min</span>
            ${episode.final_audio_duration_seconds ? `<span>Actual: ${formatDuration(episode.final_audio_duration_seconds)}</span>` : ''}
            ${episode.include_sound_effects ? '<span class="tag">üîä Sounds</span>' : ''}
            ${episode.include_background_music ? '<span class="tag">üéµ Music</span>' : ''}
        </div>
        ${episode.error_message ? `<div class="error-message">‚ùå ${escapeHtml(episode.error_message)}</div>` : ''}
    `;
    
    // Actions
    const actions = document.getElementById('page-actions');
    actions.innerHTML = renderActions();
    
    // Script tab
    renderScript();
    
    // Audio tab
    renderAudio();
    
    // Cover tab
    renderCover();
    
    // Music tab (show/hide based on project settings)
    renderMusic();
    renderSounds();
    
    // Progress
    if (isInProgress(episode.status)) {
        renderProgress();
    } else {
        document.getElementById('generation-progress').style.display = 'none';
    }
}

function renderActions() {
    const status = episode.status;
    let html = '';
    
    if (status === 'draft') {
        html = `<button class="btn btn-primary" onclick="generateScript()">Generate Script</button>`;
    } else if (status === 'script_done') {
        html = `
            <button class="btn btn-outline" onclick="regenerateScript()">Regenerate Script</button>
            <button class="btn btn-primary" onclick="generateVoiceover()">Generate Voiceover</button>
        `;
    } else if (status === 'voiceover_done') {
        html = `<button class="btn btn-primary" onclick="generateCover()">Create Cover</button>`;
    } else if (status === 'done') {
        html = `
            <button class="btn btn-outline" onclick="downloadAudio()">üì• Download Audio</button>
            <button class="btn btn-primary" onclick="createContinuation()">Create Continuation</button>
        `;
    } else if (status.endsWith('_generating')) {
        html = `
            <span class="generating-status">‚è≥ ${status.replace('_generating', '').replace('_', ' ')} in progress...</span>
            <button class="btn btn-outline btn-danger" onclick="resetGeneration()">üîÑ Reset</button>
        `;
    } else if (status === 'error') {
        html = `<button class="btn btn-primary" onclick="retryGeneration()">Retry</button>`;
    }
    
    html += ' <button class="btn btn-outline btn-danger" onclick="deleteEpisode()" title="Delete Episode">üóëÔ∏è Delete</button>';
    return html;
}

function renderScript() {
    const container = document.getElementById('script-container');
    
    if (!episode.script_json) {
        container.innerHTML = `
            <div class="empty-state-small">
                <p>No script yet. Click "Generate Script" to create one.</p>
            </div>
        `;
        return;
    }
    
    const lines = episode.script_json.lines || [];
    container.innerHTML = `
        <div class="script-header">
            <h3>${escapeHtml(episode.script_json.story_title || episode.title)}</h3>
            <span class="script-genre">${escapeHtml(episode.script_json.genre_tone || '')}</span>
        </div>
        <div class="script-lines">
            ${lines.map((line, i) => `
                <div class="script-line">
                    <div class="line-speaker">${escapeHtml(line.speaker)}</div>
                    <div class="line-text">${escapeHtml(line.text)}</div>
                    ${line.sound_effect ? `<div class="line-sound">üîä ${escapeHtml(line.sound_effect)}</div>` : ''}
                </div>
            `).join('')}
        </div>
        <div class="script-actions">
            <button class="btn btn-outline" onclick="editScript()">Edit Script</button>
        </div>
    `;
}

function renderAudio() {
    const container = document.getElementById('audio-container');
    
    const audioUrl = episode.final_audio_url || episode.voice_audio_url;
    if (!audioUrl) {
        container.innerHTML = `
            <div class="empty-state-small">
                <p>No audio yet. Generate voiceover first.</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div class="audio-player">
            <audio id="audio-element" controls>
                <source src="${audioUrl}" type="audio/mpeg">
                Your browser does not support the audio element.
            </audio>
            <div class="audio-info">
                <span>Duration: ${formatDuration(episode.final_audio_duration_seconds || episode.voice_audio_duration_seconds || 0)}</span>
                ${episode.voice_audio_url && !episode.final_audio_url ? '<span class="tag">Voice only</span>' : ''}
            </div>
        </div>
        <div class="audio-actions">
            <button class="btn btn-outline" onclick="downloadAudio()">üì• Download</button>
            <button class="btn btn-outline btn-danger" onclick="deleteAudio()">üóëÔ∏è Delete</button>
            ${episode.music_url ? `<button class="btn btn-outline" onclick="playMusic()">üéµ Play Music Only</button>` : ''}
        </div>
    `;
}

function renderCover() {
    const container = document.getElementById('cover-container');
    
    if (!episode.cover_url) {
        container.innerHTML = `
            <div class="empty-state-small">
                <p>No cover yet.</p>
                ${episode.status === 'audio_done' || episode.status === 'done' || episode.status === 'sounds_done' || episode.status === 'voiceover_done' ? 
                    '<button class="btn btn-primary" onclick="generateCover()">Generate Cover</button>' : ''}
            </div>
        `;
        return;
    }
    
    const variants = episode.cover_variants_json || [{ url: episode.cover_url, selected: true }];
    
    container.innerHTML = `
        <div class="cover-preview">
            <img src="${episode.cover_url}" alt="Episode Cover" class="cover-image">
        </div>
        ${variants.length > 1 ? `
            <div class="cover-variants">
                <h4>Variants</h4>
                <div class="variants-grid">
                    ${variants.map((v, i) => `
                        <div class="variant ${v.selected ? 'selected' : ''}" onclick="selectCover(${i})">
                            <img src="${v.url}" alt="Variant ${i + 1}">
                            <button class="variant-delete-btn" onclick="event.stopPropagation(); deleteCoverVariant(${i})" title="Delete variant">√ó</button>
                        </div>
                    `).join('')}
                </div>
            </div>
        ` : ''}
        <div class="cover-actions">
            <button class="btn btn-outline" onclick="downloadCover()">üì• Download Cover</button>
            <button class="btn btn-outline" onclick="regenerateCover()">üîÑ Regenerate</button>
        </div>
    `;
}


function renderMusic() {
    // Show/hide Music tab based on project settings
    const musicTab = document.getElementById("music-tab");
    if (episode.include_background_music) {
        musicTab.style.display = "inline-block";
    } else {
        musicTab.style.display = "none";
        return;
    }

    const container = document.getElementById("music-container");
    
    // Check if voice audio exists first
    if (!episode.voice_audio_url) {
        container.innerHTML = `
            <div class="empty-state-small">
                <p>Generate voiceover first to create background music.</p>
            </div>
        `;
        return;
    }

    // Music not generated yet
    if (!episode.music_url) {
        container.innerHTML = `
            <div class="empty-state-small">
                <p>No background music yet.</p>
                <p class="text-muted">Duration will match voiceover: ${formatDuration(episode.voice_audio_duration_seconds || 0)}</p>
                <button class="btn btn-primary" onclick="openMusicModal()">üéµ Generate Music</button>
            </div>
        `;
        return;
    }

    // Music exists
    container.innerHTML = `
        <div class="music-player">
            <h4>Background Music</h4>
            <audio controls style="width: 100%;">
                <source src="${episode.music_url}" type="audio/mpeg">
            </audio>
            <div class="audio-info">
                <span>Duration: ${formatDuration(episode.voice_audio_duration_seconds || 0)}</span>
            </div>
        </div>
        <div class="music-actions" style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <button class="btn btn-outline" onclick="downloadMusic()">üì• Download</button>
            <button class="btn btn-outline" onclick="regenerateMusic()">üîÑ Regenerate</button>
            <button class="btn btn-outline btn-danger" onclick="deleteMusic()">üóëÔ∏è Delete</button>
        </div>
        
        <div class="merge-section" style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
            <h4>Merge Voice + Music</h4>
            <div class="merge-controls" style="display: flex; align-items: center; gap: 1rem; margin: 1rem 0;">
                <label>Music Volume:</label>
                <select id="music-volume-select" class="form-select" style="width: auto;">
                    <option value="-6">-6 dB (Louder)</option>
                    <option value="-9">-9 dB</option>
                    <option value="-12" selected>-12 dB (Default)</option>
                    <option value="-15">-15 dB</option>
                    <option value="-18">-18 dB (Quieter)</option>
                </select>
                <button class="btn btn-primary" onclick="mergeAudio()">üîÄ Merge Audio</button>
                ${episode.sounds_json && episode.sounds_json.length > 0 ? `<button class="btn btn-success" onclick="mergeAll()">üéµ Merge All (Voice+Sounds+Music)</button>` : ""}
            </div>
            ${episode.final_audio_url ? `
                <div class="merged-audio" style="margin-top: 1rem;">
                    <h5>Merged Result</h5>
                    <audio controls style="width: 100%;">
                        <source src="${episode.final_audio_url}" type="audio/mpeg">
                    </audio>
                    <button class="btn btn-outline" style="margin-top: 0.5rem;" onclick="downloadMerged()">üì• Download Merged</button> <button class="btn btn-outline btn-danger" onclick="deleteMerged()">üóëÔ∏è Delete</button>
                </div>
            ` : ""}
        </div>
    `;
}

function renderSounds() {
    // Show/hide Sounds tab based on project settings
    const soundsTab = document.getElementById("sounds-tab");
    if (episode.include_sound_effects) {
        soundsTab.style.display = "inline-block";
    } else {
        soundsTab.style.display = "none";
        return;
    }

    const container = document.getElementById("sounds-container");

    // Check if voice audio exists first
    if (!episode.voice_audio_url) {
        container.innerHTML = `
            <div class="empty-state-small">
                <p>Generate voiceover first to create sound effects.</p>
            </div>
        `;
        return;
    }

    // Get sounds from script
    const lines = episode.script_json?.lines || [];
    const soundEffects = lines.filter(l => l.sound_effect).map(l => l.sound_effect);
    const uniqueSounds = [...new Set(soundEffects)];

    // Sounds not generated yet
    if (!episode.sounds_json || episode.sounds_json.length === 0) {
        container.innerHTML = `
            <div class="sounds-list">
                <h4>Sound Effects in Script (${uniqueSounds.length})</h4>
                <ul style="margin: 1rem 0; padding-left: 1.5rem;">
                    ${uniqueSounds.map(s => `<li style="margin: 0.3rem 0;">üîä ${s}</li>`).join("")}
                </ul>
                <button class="btn btn-primary" onclick="generateSounds()">üîä Generate All Sounds</button>
            </div>
        `;
        return;
    }

    // Sounds generated
    container.innerHTML = `
        <div class="sounds-generated">
            <h4>Generated Sounds (${episode.sounds_json.length})</h4>
            <div class="sounds-grid" style="display: grid; gap: 1rem; margin: 1rem 0;">
                ${episode.sounds_json.map((sound, i) => `
                    <div class="sound-item" style="padding: 0.5rem; background: var(--bg-secondary); border-radius: 8px;">
                        <p style="margin: 0 0 0.5rem 0; font-size: 0.9rem;">üîä ${sound.prompt || "Sound " + (i+1)}</p>
                        <div style="display: flex; align-items: center; gap: 0.5rem;"><audio controls style="flex: 1; height: 32px;">
                            <source src="${sound.url}" type="audio/mpeg">
                        </audio><button class="btn-icon" onclick="regenerateSingleSound(${i})" title="Regenerate">üîÑ</button></div></div>
                `).join("")}
            </div>
            <div style="margin-top: 1rem;">
            <div style="margin-bottom: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                <h5 style="margin: 0 0 0.5rem 0;">Merge Voice + Sounds</h5>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <label>Sounds Volume:
                        <select id="sounds-volume-select" style="margin-left: 0.5rem;">
                            <option value="-3">-3 dB (Loud)</option>
                            <option value="-6" selected>-6 dB (Default)</option>
                            <option value="-9">-9 dB (Quiet)</option>
                            <option value="-12">-12 dB (Very Quiet)</option>
                        </select>
                    </label>
                    <button class="btn btn-primary" onclick="mergeSounds()">üîä Merge Sounds</button>
                </div>
            </div>
                <button class="btn btn-outline" onclick="regenerateSounds()">üîÑ Regenerate All</button>
                <button class="btn btn-outline btn-danger" onclick="deleteSounds()">üóëÔ∏è Delete All</button>
            </div>
        </div>
    `;
}
function renderProgress() {
    document.getElementById('generation-progress').style.display = 'block';
    
    const steps = [
        { id: 'script', name: 'Script', icon: 'üìù' },
        { id: 'voiceover', name: 'Voiceover', icon: 'üéôÔ∏è' },
    ];
    
    if (episode.include_sound_effects) {
        steps.push({ id: 'sounds', name: 'Sounds', icon: 'üîä' });
    }
    if (episode.include_background_music) {
        steps.push({ id: 'music', name: 'Music', icon: 'üéµ' });
    }
    steps.push({ id: 'merge', name: 'Merge', icon: 'üîÑ' });
    steps.push({ id: 'cover', name: 'Cover', icon: 'üé®' });
    
    const statusMap = {
        'draft': 0,
        'script_generating': 0,
        'script_done': 1,
        'voiceover_generating': 1,
        'voiceover_done': 2,
        'sounds_generating': 2,
        'sounds_done': 3,
        'music_generating': 3,
        'music_done': 4,
        'merging': 4,
        'audio_done': 5,
        'cover_generating': 5,
        'done': 6
    };
    
    const currentStep = statusMap[episode.status] || 0;
    
    document.getElementById('progress-steps').innerHTML = steps.map((step, i) => {
        let state = 'pending';
        if (i < currentStep) state = 'done';
        else if (i === currentStep) state = 'active';
        
        return `
            <div class="progress-step ${state}">
                <span class="step-icon">${state === 'done' ? '‚úÖ' : state === 'active' ? '‚è≥' : step.icon}</span>
                <span class="step-name">${step.name}</span>
            </div>
        `;
    }).join('<div class="step-connector"></div>');
}

function startPolling() {
    if (pollInterval) clearInterval(pollInterval);
    pollInterval = setInterval(async () => {
        try {
            const result = await api.get(`/api/generation/status/${episodeId}`);
            
            if (!result.ok || !result.data) {
                console.error('Polling failed:', result.error);
                return;
            }
            
            const status = result.data;
            
            if (!isInProgress(status.status)) {
                clearInterval(pollInterval);
                loadEpisode();
                if (status.status === 'done') {
                    showToast('üéâ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!', 'success');
                } else if (status.status === 'error') {
                    const errorMsg = status.error_message || t('progress.error');
                    showToast(`‚ùå –û—à–∏–±–∫–∞: ${errorMsg}`, 'error');
                }
            } else {
                // Update progress display with detailed status
                episode.status = status.status;
                episode.current_step = status.current_step;
                episode.steps_completed = status.steps_completed || [];
                episode.error_message = status.error_message;
                renderProgress();
            }
        } catch (error) {
            console.error('Polling error:', error);
        }
    }, 2000);
}

async function generateScript() {
    try {
        const result = await api.post(`/api/generation/script/${episodeId}`, {});
        if (result.ok) {
            showToast('‚úÖ –ó–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Å–∫—Ä–∏–ø—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'success');
            loadEpisode();
        }
        // Error toast is handled by api.handleResponse
    } catch (error) {
        showError(error, t('progress.script'));
    }
}

async function generateVoiceover() {
    try {
        const result = await api.post(`/api/generation/voiceover/${episodeId}`, {});
        if (result.ok) {
            showToast('‚úÖ –ó–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –æ–∑–≤—É—á–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'success');
            loadEpisode();
        }
    } catch (error) {
        showError(error, t('progress.voice'));
    }
}

async function continueGeneration() {
    // Continue with sounds, music, merge based on episode settings
    try {
        const result = await api.post(`/api/generation/full/${episodeId}`, {});
        if (result.ok) {
            showToast(t('progress.starting'), 'info');
            loadEpisode();
        }
    } catch (error) {
        showError(error, 'Generation');
    }
}

function generateCover() {
    console.log("generateCover called");
    document.getElementById("cover-modal").classList.add("active");
}

let referenceImages = [null, null, null];

function triggerRefUpload(index) {
    document.getElementById(`ref-file-${index}`).click();
}

async function handleMultiRefUpload(event, index) {
    const file = event.target.files[0];
    if (!file) return;
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
        const response = await fetch('/api/files/upload/reference', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
            body: formData
        });
        const data = await response.json();
        if (data.url) {
            referenceImages[index] = data.url; console.log('Uploaded ref:', index, data.url, 'All refs:', referenceImages);
            const slot = document.getElementById(`ref-slot-${index}`);
            const preview = slot.querySelector('.ref-preview');
            const placeholder = slot.querySelector('.ref-placeholder');
            preview.innerHTML = `<img src="${data.url}" alt="Ref ${index+1}"><button class="ref-remove" onclick="event.stopPropagation(); clearMultiRef(${index})">√ó</button>`;
            preview.style.display = 'block';
            placeholder.style.display = 'none';
        }
    } catch (error) {
        showToast('Error uploading image', 'error');
    }
}

function clearMultiRef(index) {
    referenceImages[index] = null;
    const slot = document.getElementById(`ref-slot-${index}`);
    const preview = slot.querySelector('.ref-preview');
    const placeholder = slot.querySelector('.ref-placeholder');
    preview.style.display = 'none';
    placeholder.style.display = 'flex';
    document.getElementById(`ref-file-${index}`).value = '';
}

function clearAllRefs() {
    for (let i = 0; i < 3; i++) {
        clearMultiRef(i);
    }
}

function closeCoverModal() {
    document.getElementById("cover-modal").classList.remove("active");
    clearAllRefs();
}

function handleReferenceUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        document.getElementById("reference-image").src = e.target.result;
        document.getElementById("reference-preview").style.display = "block";
        document.getElementById("reference-placeholder").style.display = "none";
        referenceImageUrl = e.target.result;
    };
    reader.readAsDataURL(file);
}

function clearReference() {
    document.getElementById("reference-file").value = "";
    document.getElementById("reference-image").src = "";
    document.getElementById("reference-preview").style.display = "none";
    document.getElementById("reference-placeholder").style.display = "block";
    referenceImageUrl = null;
}

async function startCoverGeneration() {
    const refs = referenceImages.filter(r => r !== null);
    const variantsCount = parseInt(document.getElementById("variants-count").value);
    const aspectRatio = document.getElementById("aspect-ratio").value;
    const coverStyle = document.getElementById("cover-style").value;
    const customPrompt = document.getElementById("custom-prompt").value || null;

    // Close modal and show toast immediately
    closeCoverModal();
    showToast('‚úÖ –ó–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –æ–±–ª–æ–∂–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'success');

    try {
        const result = await api.post(`/api/generation/cover/${episodeId}`, {
            variants_count: variantsCount,
            aspect_ratio: aspectRatio,
            style: coverStyle,
            reference_images: refs.length > 0 ? refs : null,
            custom_prompt: customPrompt
        });
        if (result.ok) {
            loadEpisode();
        }
    } catch (error) {
        showError(error, t('progress.cover'));
    }
}

async function selectCover(index) {
    try {
        const result = await api.post(`/api/generation/cover/${episodeId}/select`, { variant_index: index });
        if (result.ok) {
            loadEpisode();
        }
    } catch (error) {
        showError(error, 'Select cover');
    }
}


    
    async function deleteAudio() {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å –∞—É–¥–∏–æ —Ñ–∞–π–ª? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;
        
        try {
            const response = await api.delete(`/api/episodes/${episodeId}/audio`);
            if (response.ok) {
                showToast('‚úÖ –ê—É–¥–∏–æ —É–¥–∞–ª–µ–Ω–æ', 'success');
                loadEpisode();
            } else {
                throw new Error('Failed');
            }
        } catch (error) {
            showToast('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∞—É–¥–∏–æ', 'error');
        }
    }

    async function regenerateCover() {
        if (!confirm('–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–±–ª–æ–∂–∫—É? –¢–µ–∫—É—â–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.')) return;
        document.getElementById('cover-modal').classList.add('active');
    }
    
    async function regenerateScript() {
        if (!confirm('–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–∫—Ä–∏–ø—Ç? –¢–µ–∫—É—â–∏–π —Å–∫—Ä–∏–ø—Ç –±—É–¥–µ—Ç –∑–∞–º–µ–Ω—ë–Ω.')) return;
        
        try {
            const response = await api.post(`/api/generation/script/${episodeId}`);
            if (response.ok) {
                showToast('‚úÖ –ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Å–∫—Ä–∏–ø—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'success');
                startPolling();
            } else {
                throw new Error('Failed');
            }
        } catch (error) {
            showToast('‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∫—Ä–∏–ø—Ç–∞', 'error');
        }
    }

async function deleteCoverVariant(index) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç –æ–±–ª–æ–∂–∫–∏?')) return;
    
    try {
        const result = await api.delete(`/api/episodes/${episodeId}/cover/${index}`);
        if (result.ok) {
            showToast('‚úÖ –í–∞—Ä–∏–∞–Ω—Ç –æ–±–ª–æ–∂–∫–∏ —É–¥–∞–ª–µ–Ω', 'success');
            loadEpisode();
        }
    } catch (error) {
        showError(error, 'Delete cover variant');
    }
}

function editScript() {
    if (!episode.script_json || !episode.script_json.lines) {
        showToast("No script to edit", "error");
        return;
    }
    
    const lines = episode.script_json.lines;
    let html = `
        <div id="script-editor-modal" class="modal active">
            <div class="modal-backdrop" onclick="closeScriptEditor()"></div>
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h3>Edit Script</h3>
                    <button class="modal-close" onclick="closeScriptEditor()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="script-lines">
    `;
    
    lines.forEach((line, index) => {
        html += `
            <div class="script-line" data-index="${index}">
                <div class="line-header">
                    <span class="speaker-name">${line.speaker}</span>
                    <button class="btn btn-sm btn-danger" onclick="deleteScriptLine(${index})">üóëÔ∏è</button>
                </div>
                <textarea class="line-text" data-index="${index}" rows="3">${line.text}</textarea>
            </div>
        `;
    });
    
    html += `
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="closeScriptEditor()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveScript()">Save Changes</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', html);
}

function closeScriptEditor() {
    const modal = document.getElementById('script-editor-modal');
    if (modal) modal.remove();
}

function deleteScriptLine(index) {
    if (!confirm('Delete this line?')) return;
    const lineEl = document.querySelector(`.script-line[data-index="${index}"]`);
    if (lineEl) lineEl.remove();
}

async function saveScript() {
    const textareas = document.querySelectorAll('.script-line .line-text');
    const newLines = [];
    const originalLines = episode.script_json.lines;
    
    textareas.forEach((textarea) => {
        const index = parseInt(textarea.dataset.index);
        const originalLine = originalLines[index];
        if (originalLine) {
            newLines.push({
                ...originalLine,
                text: textarea.value
            });
        }
    });
    
    const newScriptJson = {
        ...episode.script_json,
        lines: newLines
    };
    
    try {
        const response = await api.put(`/api/episodes/${episodeId}/script`, {
            script_json: newScriptJson
        });
        
        if (response.ok) {
            showToast('‚úÖ Script saved', 'success');
            closeScriptEditor();
            loadEpisode();
        } else {
            throw new Error('Failed to save');
        }
    } catch (error) {
        showToast('‚ùå Error saving script', 'error');
    }
}

function downloadAudio() {
    window.open(`/api/files/audio/${episodeId}`, '_blank');
}

function downloadCover() {
    window.open(`/api/files/cover/${episodeId}`, '_blank');
}


async function resetGeneration() {
    if (!confirm("Reset current generation? This will cancel the process and clear partial data.")) {
        return;
    }
    try {
        const result = await api.post(`/api/episodes/${episodeId}/reset`);
        showToast(result.message || "Generation reset successfully", "success");
        await loadEpisode();
    } catch (error) {
        showError(error, "Reset generation");
    }
}

async function createContinuation() {
    const description = prompt(t('episode.continuation_prompt') || 'Enter description for the continuation episode:');
    if (!description) return;
    
    try {
        const result = await api.post(`/api/episodes/${episodeId}/continuation`, {
            description: description,
            title_auto_generated: true,
            show_episode_number: true,
            target_duration_minutes: episode.target_duration_minutes
        });
        
        if (result.ok && result.data) {
            showToast(t('episode.continuation_created') || 'Continuation created!', 'success');
            window.location.href = `/episodes/${result.data.id}`;
        }
    } catch (error) {
        showError(error, 'Create continuation');
    }
}

// Tab handling
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        tab.classList.add('active');
        document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
    });
});

// Load on page load
// ============ MUSIC FUNCTIONS ============

function openMusicModal() {
    generateMusic();
}

async function generateMusic() {
    showToast("üéµ Generating background music...", "info");
    
    try {
        const result = await api.post(`/api/generation/music/${episodeId}`, {
            prompt: null,
            music_volume_db: -12
        });
        
        if (result.ok) {
            showToast("‚úÖ Music generated successfully!", "success");
            loadEpisode();
        }
    } catch (error) {
        showError(error, "Generate music");
    }
}

async function regenerateMusic() {
    if (!confirm("Regenerate background music?")) return;
    await generateMusic();
}

async function deleteMusic() {
    if (!confirm("Delete background music?")) return;
    
    try {
        const result = await api.delete(`/api/generation/music/${episodeId}`);
        if (result.ok) {
            showToast("Music deleted", "success");
            loadEpisode();
        }
    } catch (error) {
        showError(error, "Delete music");
    }
}

async function generateSounds() {
    showToast("üîä Generating sound effects...", "info");
    
    try {
        const result = await api.post(`/api/generation/sounds/${episodeId}`, {});
        if (result.ok) {
            showToast("Sound effects generated!", "success");
            loadEpisode();
        }
    } catch (error) {
        showError(error, "Generate sounds");
    }
}

async function regenerateSounds() {
    if (!confirm("Regenerate all sound effects?")) return;
    await deleteSounds();
    await generateSounds();
}

async function deleteSounds() {
    if (!confirm("Delete all sound effects?")) return;
    
    try {
        const result = await api.delete(`/api/generation/sounds/${episodeId}`);
        if (result.ok) {
            showToast("Sounds deleted", "success");
            loadEpisode();
        }
    } catch (error) {
        showError(error, "Delete sounds");
    }
}

async function mergeSounds() {
    const volumeSelect = document.getElementById("sounds-volume-select");
    const soundsVolumeDb = parseFloat(volumeSelect.value);

    showToast("üîä Merging voice with sounds...", "info");

    try {
        const result = await api.post(`/api/generation/sounds/${episodeId}/merge`, {
            sounds_volume_db: soundsVolumeDb
        });
        if (result.ok) {
            showToast("Audio merged with sounds!", "success");
            loadEpisode();
        }
    } catch (error) {
        showError(error, "Merge sounds");
    }
}

async function regenerateSingleSound(index) {
    const sound = episode.sounds_json[index];
    if (!sound) return;
    
    showToast(`üîä Regenerating: ${sound.prompt}...`, "info");
    
    try {
        const result = await api.post(`/api/generation/sounds/${episodeId}/single`, {
            index: index,
            prompt: sound.prompt
        });
        if (result.ok) {
            showToast("Sound regenerated!", "success");
            loadEpisode();
        }
    } catch (error) {
        showError(error, "Regenerate sound");
    }
}

async function mergeAudio() {
    const volumeSelect = document.getElementById("music-volume-select");
    const musicVolumeDb = parseFloat(volumeSelect.value);
    
    showToast("üîÄ Merging audio...", "info");
    
    try {
        const result = await api.post(`/api/generation/music/${episodeId}/merge`, {
            music_volume_db: musicVolumeDb
        });
        
        if (result.ok) {
            showToast("‚úÖ Audio merged successfully!", "success");
            loadEpisode();
        }
    } catch (error) {
        showError(error, "Merge audio");
    }

}
async function mergeAll() {
    const musicVolumeDb = parseFloat(document.getElementById("music-volume-select").value);
    const soundsVolumeDb = document.getElementById("sounds-volume-select") ? parseFloat(document.getElementById("sounds-volume-select").value) : -6.0;

    showToast("üéµ Merging voice + sounds + music...", "info");

    try {
        const result = await api.post(`/api/generation/merge/${episodeId}/all`, {
            sounds_volume_db: soundsVolumeDb,
            music_volume_db: musicVolumeDb
        });
        if (result.ok) {
            showToast("Full audio merge complete!", "success");
            loadEpisode();
        }
    } catch (error) {
        showError(error, "Merge all");
    }
}

function downloadMusic() {
    if (episode.music_url) {
        window.open(episode.music_url, "_blank");
    }
}

function playMusic() {
    if (episode.music_url) {
        const audio = new Audio(episode.music_url);
        audio.play();
        showToast("üéµ Playing music...", "info");
    }
}

function downloadMerged() {
    if (episode.final_audio_url) {
        window.open(episode.final_audio_url, "_blank");
    }
}

async function deleteMerged() {
    if (!confirm("Delete merged audio?")) return;
    
    try {
        const result = await api.delete(`/api/generation/music/${episodeId}/merged`);
        if (result.ok) {
            showToast("Merged audio deleted", "success");
            loadEpisode();
        }
    } catch (error) {
        showError(error, "Delete merged");
    }
}


async function deleteEpisode() {
    if (!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —ç–ø–∏–∑–æ–¥? –í—Å–µ —Ñ–∞–π–ª—ã (—Å–∫—Ä–∏–ø—Ç, –∞—É–¥–∏–æ, –æ–±–ª–æ–∂–∫–∏) –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!")) return;
    try {
        const result = await api.delete(`/api/episodes/${episodeId}`);
        if (result.ok) {
            showToast("–≠–ø–∏–∑–æ–¥ —É–¥–∞–ª—ë–Ω", "success");
            window.location.href = `/projects/${episode.project_id}`;
        } else {
            showError(result.error || "Failed to delete episode");
        }
    } catch (error) {
        showError(error, "Delete episode");
    }
}

document.addEventListener('DOMContentLoaded', () => { loadEpisode(); loadCoverStyles(); });

// Cleanup on page leave
window.addEventListener('beforeunload', () => {
    if (pollInterval) clearInterval(pollInterval);
});
</script>
{% endblock %}
