{% extends "base.html" %}

{% block title %}Settings - HeinerCast{% endblock %}

{% block content %}
<style>
.styles-list { margin: 1rem 0; }
.style-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border-bottom: 1px solid #333; }
.style-item:hover { background: rgba(255,255,255,0.05); }
.style-emoji { font-size: 1.2rem; width: 2rem; }
.style-name { flex: 1; font-weight: 500; }
.style-key { color: #888; font-size: 0.85rem; }
.style-active { width: 1.5rem; }
.btn-icon { background: none; border: none; cursor: pointer; padding: 0.25rem; font-size: 1rem; }
.btn-icon:hover { opacity: 0.7; }
.modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; }
.modal-content { background: #1a1a2e; padding: 2rem; border-radius: 8px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
.modal-content h3 { margin-top: 0; }
.form-actions { display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem; }
</style>
<div class="settings-page">
    <h1>Settings</h1>
    
    <div class="settings-tabs">
        <button class="settings-tab active" data-tab="profile">Profile</button>
        <button class="settings-tab" data-tab="llm">LLM Provider</button>
        <button class="settings-tab" data-tab="elevenlabs">ElevenLabs</button>
        <button class="settings-tab" data-tab="covers">Covers</button>
        <button class="settings-tab" data-tab="prompts">AI Prompts</button>
        <button class="settings-tab" data-tab="templates">Templates</button>
        <button class="settings-tab" data-tab="apikeys">API Keys</button>
    </div>
    
    <!-- Profile Tab -->
    <div class="settings-content active" id="tab-profile">
        <div class="settings-card">
            <h2>Profile Settings</h2>
            <form id="profile-form" onsubmit="saveProfile(event)">
                <div class="form-group">
                    <label for="profile-email">Email</label>
                    <input type="email" id="profile-email" required>
                </div>
                <div class="form-group">
                    <label for="profile-username">Username</label>
                    <input type="text" id="profile-username" required pattern="^[a-zA-Z0-9_]+$">
                </div>
                <div class="form-group">
                    <label for="profile-language">Language</label>
                    <select id="profile-language">
                        <option value="en">English</option>
                        <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                        <option value="de">Deutsch</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </form>
        </div>
        
        <div class="settings-card">
            <h2>Change Password</h2>
            <form id="password-form" onsubmit="changePassword(event)">
                <div class="form-group">
                    <label for="current-password">Current Password</label>
                    <input type="password" id="current-password" required>
                </div>
                <div class="form-group">
                    <label for="new-password">New Password</label>
                    <input type="password" id="new-password" required minlength="8">
                </div>
                <button type="submit" class="btn btn-outline">Change Password</button>
            </form>
        </div>
    </div>
    
    <!-- LLM Tab -->
    <div class="settings-content" id="tab-llm">
        <div class="settings-card">
            <h2>LLM Provider Settings</h2>
            <p class="settings-description">Configure the AI provider for script generation</p>
            <form id="llm-form" onsubmit="saveLLMSettings(event)">
                <div class="form-group">
                    <label for="llm-provider">Provider</label>
                    <select id="llm-provider" onchange="updateModelOptions()">
                        <option value="openrouter">OpenRouter</option>
                        <option value="polza">Polza.ai</option>
                        <option value="openai">OpenAI</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="llm-api-key">API Key</label>
                    <input type="password" id="llm-api-key" placeholder="Enter your API key">
                    <span class="form-hint" id="llm-key-status"></span>
                </div>
                <div class="form-group">
                    <label for="llm-model">Model</label>
                    <select id="llm-model">
                        <!-- Options loaded dynamically -->
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Save LLM Settings</button>
            </form>
        </div>
    </div>
    
    <!-- ElevenLabs Tab -->
    <div class="settings-content" id="tab-elevenlabs">
        <div class="settings-card">
            <h2>ElevenLabs Settings</h2>
            <p class="settings-description">Configure ElevenLabs for voice generation</p>
            <form id="elevenlabs-form" onsubmit="saveElevenLabsSettings(event)">
                <div class="form-group">
                    <label for="elevenlabs-api-key">API Key</label>
                    <input type="password" id="elevenlabs-api-key" placeholder="Enter your ElevenLabs API key">
                    <span class="form-hint" id="elevenlabs-key-status"></span>
                </div>
                <button type="submit" class="btn btn-primary">Save ElevenLabs Settings</button>
            </form>
        </div>
    </div>
    
    <!-- Covers Tab -->
    <div class="settings-content" id="tab-covers">
        <div class="settings-card">
            <h2>kie.ai Settings</h2>
            <p class="settings-description">Configure kie.ai for cover image generation</p>
            <form id="kieai-form" onsubmit="saveKieAISettings(event)">
                <div class="form-group">
                    <label for="kieai-api-key">API Key</label>
                    <input type="password" id="kieai-api-key" placeholder="Enter your kie.ai API key">
                    <span class="form-hint" id="kieai-key-status"></span>
                </div>
                <button type="submit" class="btn btn-primary">Save kie.ai Settings</button>
            </form>
        </div>

        <div class="settings-card">
            <h2>Cover Styles</h2>
            <p class="settings-description">Manage cover art styles for different types of books</p>
            <div id="styles-list" class="styles-list"></div>
            <button type="button" class="btn btn-secondary" onclick="showAddStyleModal()">+ Add New Style</button>
        </div>

        <!-- Add/Edit Style Modal -->
        <div id="style-modal" class="modal" style="display:none;">
            <div class="modal-content">
                <h3 id="style-modal-title">Add New Style</h3>
                <form id="style-form" onsubmit="saveStyle(event)">
                    <input type="hidden" id="style-id">
                    <div class="form-group">
                        <label>Key (unique identifier)</label>
                        <input type="text" id="style-key" required pattern="^[a-z0-9_]+$" placeholder="e.g. fairy_tale">
                    </div>
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="style-name" required placeholder="e.g. Fairy Tale">
                    </div>
                    <div class="form-group">
                        <label>Emoji</label>
                        <input type="text" id="style-emoji" maxlength="4" placeholder="üßö">
                    </div>
                    <div class="form-group">
                        <label>Instructions (for AI image generation)</label>
                        <textarea id="style-instructions" rows="4" required placeholder="Magical forest, soft pastel colors, fairy dust particles..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Mood</label>
                        <input type="text" id="style-mood" required placeholder="magical, whimsical, enchanting">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeStyleModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Style</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Prompts Tab -->
    <div class="settings-content" id="tab-prompts">
        <div class="settings-card">
            <h2>AI Writer Prompt</h2>
            <p class="settings-description">Customize the system prompt for script generation</p>
            <form id="prompts-form" onsubmit="savePrompts(event)">
                <div class="form-group">
                    <label for="ai-writer-prompt">System Prompt</label>
                    <textarea id="ai-writer-prompt" rows="15" class="code-textarea"></textarea>
                </div>
                <div class="form-group">
                    <label for="ai-methodology">Writing Methodology (Optional)</label>
                    <textarea id="ai-methodology" rows="12" class="code-textarea" placeholder="Add writing methodology, guidelines, or reference materials that will be included when generating scripts..."></textarea>
                    <span class="form-hint">This content will be added to the context when generating scripts. Leave empty if not needed.</span>
                </div>
                <div class="form-group">
                    <label for="cover-prompt-template">Cover Prompt Template</label>
                    <textarea id="cover-prompt-template" rows="8" class="code-textarea"></textarea>
                    <span class="form-hint">Use {title}, {genre_tone}, {description} as placeholders</span>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="resetPrompts()">Reset to Defaults</button>
                    <button type="submit" class="btn btn-primary">Save Prompts</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- API Keys Tab -->
    
    <!-- Templates Tab -->
    <div class="settings-content" id="tab-templates">
        <h2>Project Templates</h2>
        <p>Manage your saved project templates.</p>
        
        <div id="templates-list" style="margin-top: 1rem;">
            <div class="loading-spinner">Loading templates...</div>
        </div>
    </div>

    <div class="settings-content" id="tab-apikeys">
        <div class="settings-card">
            <h2>API Keys</h2>
            <p class="settings-description">Manage API keys for programmatic access</p>
            <button class="btn btn-primary" onclick="showCreateAPIKeyModal()">Create New API Key</button>
            
            <div class="api-keys-list" id="api-keys-list">
                <!-- API keys will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Create API Key Modal -->
<div class="modal" id="create-apikey-modal" style="display:none">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Create API Key</h2>
            <button class="modal-close" onclick="closeModal('create-apikey-modal')">&times;</button>
        </div>
        <form id="create-apikey-form" onsubmit="createAPIKey(event)">
            <div class="form-group">
                <label for="apikey-name">Name</label>
                <input type="text" id="apikey-name" required maxlength="100"
                       placeholder="e.g., My Integration">
            </div>
            <div class="form-group">
                <label for="apikey-expires">Expires in (days)</label>
                <input type="number" id="apikey-expires" value="365" min="1" max="3650">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('create-apikey-modal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Key</button>
            </div>
        </form>
    </div>
</div>

<!-- Show API Key Modal -->
<div class="modal" id="show-apikey-modal" style="display:none">
    <div class="modal-content">
        <div class="modal-header">
            <h2>API Key Created</h2>
            <button class="modal-close" onclick="closeModal('show-apikey-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <p class="warning-text">‚ö†Ô∏è Copy this key now. You won't be able to see it again!</p>
            <div class="api-key-display" id="new-api-key"></div>
            <button class="btn btn-outline" onclick="copyAPIKey()">üìã Copy to Clipboard</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let settings = null;
let providers = {};

function closeModal(modalId) {
    document.getElementById(modalId).style.display = "none";
}

async function loadSettings() {
    try {
        const result = await api.get('/api/users/settings');
        if (result.ok && result.data) {
            settings = result.data;
            populateSettings();
        }
        
        // Load providers
        const providersResult = await api.get('/api/settings/providers');
        if (providersResult.ok && providersResult.data) {
            providers = providersResult.data.providers.reduce((acc, p) => {
                acc[p.id] = p;
                return acc;
            }, {});
        }
        
        updateModelOptions();
        loadAPIKeys();
    } catch (error) {
        showError(error, 'Load settings');
    }
}

function populateSettings() {
    // Profile
    document.getElementById('profile-email').value = settings.email;
    document.getElementById('profile-username').value = settings.username;
    document.getElementById('profile-language').value = settings.language;
    
    // LLM
    document.getElementById('llm-provider').value = settings.llm_provider;
    document.getElementById('llm-key-status').textContent = settings.has_llm_api_key ? '‚úÖ Key configured' : '‚ö†Ô∏è No key set';
    if (settings.llm_model) {
        document.getElementById('llm-model').value = settings.llm_model;
    }
    
    // ElevenLabs
    document.getElementById('elevenlabs-key-status').textContent = settings.has_elevenlabs_api_key ? '‚úÖ Key configured' : '‚ö†Ô∏è No key set';
    
    // kie.ai
    document.getElementById('kieai-key-status').textContent = settings.has_kieai_api_key ? '‚úÖ Key configured' : '‚ö†Ô∏è No key set';
    
    // Prompts
    document.getElementById('ai-writer-prompt').value = settings.ai_writer_prompt;
    document.getElementById('ai-methodology').value = settings.ai_methodology || '';
    document.getElementById('cover-prompt-template').value = settings.cover_prompt_template;
}

function updateModelOptions() {
    const provider = document.getElementById('llm-provider').value;
    const select = document.getElementById('llm-model');
    const models = providers[provider]?.models || [];
    
    select.innerHTML = models.map(m => `<option value="${m}">${m}</option>`).join('');
    
    if (settings && settings.llm_model && models.includes(settings.llm_model)) {
        select.value = settings.llm_model;
    }
}

async function saveProfile(event) {
    event.preventDefault();
    
    try {
        const result = await api.put('/api/users/settings', {
            email: document.getElementById('profile-email').value,
            username: document.getElementById('profile-username').value,
            language: document.getElementById('profile-language').value
        });
        
        if (result.ok) {
            showToast('Profile saved!', 'success');
        }
        // Error already shown by handleResponse
    } catch (error) {
        showError(error, 'Save profile');
    }
}

async function changePassword(event) {
    event.preventDefault();
    
    try {
        const result = await api.post('/api/auth/change-password', {
            current_password: document.getElementById('current-password').value,
            new_password: document.getElementById('new-password').value
        });
        
        if (result.ok) {
            showToast('Password changed!', 'success');
            document.getElementById('password-form').reset();
        }
        // Error already shown by handleResponse
    } catch (error) {
        showError(error, 'Change password');
    }
}

async function saveLLMSettings(event) {
    event.preventDefault();
    
    const data = {
        llm_provider: document.getElementById('llm-provider').value,
        llm_model: document.getElementById('llm-model').value
    };
    
    const apiKey = document.getElementById('llm-api-key').value;
    if (apiKey) {
        data.llm_api_key = apiKey;
    }
    
    try {
        const result = await api.put('/api/users/settings/llm', data);
        if (result.ok) {
            showToast('LLM settings saved!', 'success');
            document.getElementById('llm-api-key').value = '';
            loadSettings();
        }
    } catch (error) {
        showError(error, 'Save LLM settings');
    }
}

async function saveElevenLabsSettings(event) {
    event.preventDefault();
    
    const apiKey = document.getElementById('elevenlabs-api-key').value;
    if (!apiKey) {
        showToast('Please enter an API key', 'warning');
        return;
    }
    
    try {
        const result = await api.put('/api/users/settings/elevenlabs', {
            elevenlabs_api_key: apiKey
        });
        if (result.ok) {
            showToast('ElevenLabs settings saved!', 'success');
            document.getElementById('elevenlabs-api-key').value = '';
            loadSettings();
        }
    } catch (error) {
        showError(error, 'Save ElevenLabs settings');
    }
}

async function saveKieAISettings(event) {
    event.preventDefault();
    
    const apiKey = document.getElementById('kieai-api-key').value;
    if (!apiKey) {
        showToast('Please enter an API key', 'warning');
        return;
    }
    
    try {
        const result = await api.put('/api/users/settings/kieai', {
            kieai_api_key: apiKey
        });
        if (result.ok) {
            showToast('kie.ai settings saved!', 'success');
            document.getElementById('kieai-api-key').value = '';
            loadSettings();
        }
    } catch (error) {
        showError(error, 'Save kie.ai settings');
    }
}

async function savePrompts(event) {
    event.preventDefault();
    
    try {
        const result = await api.put('/api/users/settings/prompts', {
            ai_writer_prompt: document.getElementById('ai-writer-prompt').value,
            ai_methodology: document.getElementById('ai-methodology').value || null,
            cover_prompt_template: document.getElementById('cover-prompt-template').value
        });
        if (result.ok) {
            showToast('Prompts saved!', 'success');
        }
    } catch (error) {
        showError(error, 'Save prompts');
    }
}

async function resetPrompts() {
    if (!confirm('Reset prompts to default values?')) return;
    
    try {
        const result = await api.post('/api/users/settings/prompts/reset');
        if (result.ok) {
            showToast('Prompts reset!', 'success');
            loadSettings();
        }
    } catch (error) {
        showError(error, 'Reset prompts');
    }
}

async function loadAPIKeys() {
    try {
        const result = await api.get('/api/users/api-keys');
        
        if (!result.ok || !result.data) return;
        
        const data = result.data;
        const list = document.getElementById('api-keys-list');
        const items = data.items || [];
        
        if (items.length === 0) {
            list.innerHTML = '<p class="empty-text">No API keys yet</p>';
            return;
        }
        
        list.innerHTML = items.map(key => `
            <div class="api-key-item">
                <div class="api-key-info">
                    <strong>${escapeHtml(key.name)}</strong>
                    <span class="api-key-meta">
                        Created: ${formatDate(key.created_at)}
                        ${key.last_used_at ? ` ‚Ä¢ Last used: ${formatDate(key.last_used_at)}` : ''}
                        ${key.expires_at ? ` ‚Ä¢ Expires: ${formatDate(key.expires_at)}` : ''}
                    </span>
                </div>
                <button class="btn btn-danger-outline btn-sm" onclick="revokeAPIKey('${key.id}')">
                    Revoke
                </button>
            </div>
        `).join('');
    } catch (error) {
        console.error('Failed to load API keys', error);
    }
}

function showCreateAPIKeyModal() {
    document.getElementById('create-apikey-form').reset();
    document.getElementById('create-apikey-modal').style.display = 'flex';
}

async function createAPIKey(event) {
    event.preventDefault();
    
    try {
        const result = await api.post('/api/users/api-keys', {
            name: document.getElementById('apikey-name').value,
            expires_in_days: parseInt(document.getElementById('apikey-expires').value)
        });
        
        if (result.ok && result.data) {
            closeModal('create-apikey-modal');
            document.getElementById('new-api-key').textContent = result.data.api_key;
            document.getElementById('show-apikey-modal').style.display = 'flex';
            loadAPIKeys();
        }
        // Error already shown by handleResponse
    } catch (error) {
        showError(error, 'Create API key');
    }
}

function copyAPIKey() {
    const key = document.getElementById('new-api-key').textContent;
    navigator.clipboard.writeText(key);
    showToast('API key copied!', 'success');
}

async function revokeAPIKey(keyId) {
    if (!confirm('Revoke this API key? This cannot be undone.')) return;
    
    try {
        const result = await api.delete(`/api/users/api-keys/${keyId}`);
        if (result.ok) {
            showToast('API key revoked', 'success');
            loadAPIKeys();
        }
    } catch (error) {
        showError(error, 'Revoke API key');
    }
}

// Tab handling
document.querySelectorAll('.settings-tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.settings-content').forEach(c => c.classList.remove('active'));
        
        tab.classList.add('active');
        document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
    });
});

// Load on page load
document.addEventListener('DOMContentLoaded', loadSettings);

// Cover Styles Management
let coverStyles = [];

async function loadCoverStyles() {
    try {
        const result = await api.get("/api/cover-styles");
        coverStyles = result.data || result;
        renderStylesList();
    } catch (e) {
        console.error("Failed to load styles:", e);
    }
}

function renderStylesList() {
    const list = document.getElementById("styles-list");
    if (!list) return;
    list.innerHTML = coverStyles.map(s => `
        <div class="style-item" data-id="${s.id}">
            <span class="style-emoji">${s.emoji}</span>
            <span class="style-name">${s.name}</span>
            <span class="style-key">(${s.key})</span>
            <span class="style-active">${s.is_active ? "‚úì" : "‚óã"}</span>
            <button class="btn-icon" onclick="editStyle('${s.id}')" title="Edit">‚úèÔ∏è</button>
            <button class="btn-icon" onclick="toggleStyle('${s.id}', ${!s.is_active})" title="Toggle">${s.is_active ? "üî¥" : "üü¢"}</button>
            ${s.key !== "auto" ? `<button class="btn-icon" onclick="deleteStyle('${s.id}')" title="Delete">üóëÔ∏è</button>` : ""}
        </div>
    `).join("");
}

function showAddStyleModal() {
    document.getElementById("style-modal-title").textContent = "Add New Style";
    document.getElementById("style-id").value = "";
    document.getElementById("style-key").value = "";
    document.getElementById("style-key").disabled = false;
    document.getElementById("style-name").value = "";
    document.getElementById("style-emoji").value = "üé®";
    document.getElementById("style-instructions").value = "";
    document.getElementById("style-mood").value = "";
    document.getElementById("style-modal").style.display = "flex";
}

function editStyle(id) {
    const style = coverStyles.find(s => s.id === id);
    if (!style) return;
    document.getElementById("style-modal-title").textContent = "Edit Style";
    document.getElementById("style-id").value = style.id;
    document.getElementById("style-key").value = style.key;
    document.getElementById("style-key").disabled = true;
    document.getElementById("style-name").value = style.name;
    document.getElementById("style-emoji").value = style.emoji;
    document.getElementById("style-instructions").value = style.instructions;
    document.getElementById("style-mood").value = style.mood;
    document.getElementById("style-modal").style.display = "flex";
}

function closeStyleModal() {
    document.getElementById("style-modal").style.display = "none";
}

async function saveStyle(event) {
    event.preventDefault();
    const id = document.getElementById("style-id").value;
    const data = {
        key: document.getElementById("style-key").value,
        name: document.getElementById("style-name").value,
        emoji: document.getElementById("style-emoji").value || "üé®",
        instructions: document.getElementById("style-instructions").value,
        mood: document.getElementById("style-mood").value
    };
    try {
        if (id) {
            await api.put(`/api/cover-styles/${id}`, data);
        } else {
            await api.post("/api/cover-styles", data);
        }
        closeStyleModal();
        loadCoverStyles();
        showToast("Style saved!", "success");
    } catch (e) {
        showToast("Failed to save style", "error");
    }
}

async function toggleStyle(id, active) {
    try {
        await api.put(`/api/cover-styles/${id}`, { is_active: active });
        loadCoverStyles();
    } catch (e) {
        showToast("Failed to toggle style", "error");
    }
}

async function deleteStyle(id) {
    if (!confirm("Delete this style?")) return;
    try {
        await api.delete(`/api/cover-styles/${id}`);
        loadCoverStyles();
        showToast("Style deleted", "success");
    } catch (e) {
        showToast("Failed to delete style", "error");
    }
}

// Load styles when page loads
document.addEventListener("DOMContentLoaded", loadCoverStyles);

// Templates Management
async function loadSettingsTemplates() {
    try {
        const result = await api.get('/api/templates');
        if (result.ok && result.data) {
            renderSettingsTemplates(result.data);
        }
    } catch (error) {
        console.error('Failed to load templates', error);
    }
}

function renderSettingsTemplates(templates) {
    const container = document.getElementById('templates-list');
    if (!templates || templates.length === 0) {
        container.innerHTML = '<p style="color: #888;">No templates yet. Save a project as template from the project page.</p>';
        return;
    }
    
    container.innerHTML = templates.map(t => `
        <div class="style-item">
            <span class="style-emoji">üìã</span>
            <span class="style-name">${t.name}</span>
            <span class="style-key">${t.genre_tone || 'No genre'}</span>
            <span class="style-key">${(t.characters_json || []).length} chars</span>
            <button class="btn-icon" onclick="deleteTemplate('${t.id}')" title="Delete">üóëÔ∏è</button>
        </div>
    `).join('');
}

async function deleteTemplate(id) {
    if (!confirm('Delete this template?')) return;
    
    try {
        const result = await api.delete(`/api/templates/${id}`);
        if (result.ok) {
            showToast('Template deleted', 'success');
            loadSettingsTemplates();
        }
    } catch (error) {
        showError(error, 'Delete template');
    }
}

// Load templates when tab is clicked
document.addEventListener('DOMContentLoaded', () => {
    const templatesTab = document.querySelector('[data-tab="templates"]');
    if (templatesTab) {
        templatesTab.addEventListener('click', loadSettingsTemplates);
    }
});

</script>
{% endblock %}
